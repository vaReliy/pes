<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PES</title>
</head>
<body>
<script>

    var FPS = 60;
    var WIDTH = 800;
    var HEIGHT = 500;
    var RECT_SIDE_W = 37.5;
    var RECT_SIDE_H = 60;
    var SPEED = 200;

    var _mouseX = WIDTH/2;
    var _mouseY = HEIGHT/2;
    var _currentRenderTime, _deltaRenderTime, _lastRenderTime;
    var scaleTime = Date.now();

    var _canvas, _context, _jakeImg, _pes, _rocket;

    init();
    render();

    /*document.addEventListener('visibilitychange', function(event)
    {
        console.log(event);
    });*/

    function init()
    {
        _canvas = document.createElement("canvas");
//        _canvas.onmousemove = onMouseMove;
        _canvas.onmouseup = onMouseUp;
        _canvas.width = WIDTH;
        _canvas.height = HEIGHT;
        _context = _canvas.getContext("2d");
        document.body.appendChild( _canvas );

        var textures = [];
        _jakeImg = new Image();
        _jakeImg.src = "../resources/jake.png";

        _jakeImg.onload = function ()
        {
            textures = generateTextures();
            _pes = new Pes(WIDTH/2, HEIGHT/2, RECT_SIDE_W, RECT_SIDE_H, textures, _context, FPS/4);
            _rocket = new Rocket(0, 0, 10, 10, null, _context, FPS/4);
        };
    }


    function generateTextures()
    {
        var arr = [], x = 0, y = 180, w = RECT_SIDE_W, h = RECT_SIDE_H, currentFrameIndex = 0;
        var obj =
        {
            dx: x,
            dy: y,
            dw: w,
            dh: h,
            currentFrameIndex: currentFrameIndex
        };
        var frame = new JakeFrame(obj);
        arr.push(frame);
        obj.dy -= h*2;
        for (var i=1; i < 9; i++)
        {
            if (i != 1)
                obj.dx += w;
            obj.currentFrameIndex = i;
            frame = new JakeFrame(obj);
            arr.push(frame);
        }
        return arr;
    }

    function render() {

        _currentRenderTime = Date.now();
        _deltaRenderTime = _currentRenderTime - _lastRenderTime;

        globalUpdate();
        globalRender();
        requestAnimationFrame( render );

        _lastRenderTime = _currentRenderTime;
    }

    function globalRender()
    {
        _context.clearRect(0, 0, WIDTH, HEIGHT);
        _context.strokeRect(0, 0, WIDTH, HEIGHT);

        if (_pes) //TODO: insert in proto function
        {
            _pes.draw();
        }
        if (_rocket)
        {
            _rocket.draw();
        }
    }

    function globalUpdate()
    {
        if (_pes) //TODO: insert in proto function
        {
//            _pes.updatePosition(_mouseX, _mouseY);
            _pes.x = _mouseX;
            _pes.y = _mouseY;
        }
        if(_rocket)
            _rocket.updateTarget(_pes.x, _pes.y);
    }

    function onMouseMove(event)
    {
        _mouseX = event.offsetX;
        _mouseY = event.offsetY;
    }

    function onMouseUp(event)
    {
        onMouseMove(event);
        console.log("up! _mouseX=" + _mouseX + ", _mouseY=" + _mouseY);
    }


    /* class JakeFrame */
    function JakeFrame(frameObject)
    {
        this.dx = frameObject.dx;
        this.dy = frameObject.dy;
        this.dw = frameObject.dw;
        this.dh = frameObject.dh;
        this.currentFrameIndex = frameObject.currentFrameIndex;

    }


    /* class Pes */
    function Pes(x, y, w, h, textures, context, fps)
    {
        this.x = x;
        this.y = y;
        this.width = w;
        this.height = h;
        this.textures = textures;
        this.context = context;
        this.fps = fps;

        this.isMoved = false;
        this.isMovedLeft = false;
        this.currentFrameIndex = 0;
        this.lastAnimationTime = 0;

        this.drawX = function(x)
        {
            return (x - this.width / 2);
        };
        this.drawY = function(y)
        {
            return (y - this.height / 2);
        };

    }

    Pes.prototype.incrementMovingFrame = function()
    {
        if (this.currentFrameIndex < this.textures.length-1)
            this.currentFrameIndex++;
        if (this.currentFrameIndex == this.textures.length-1)
            this.currentFrameIndex = 1;
    };


    Pes.prototype.draw = function()
    {
        if (this.isMoved)
        {
            var dt = _currentRenderTime - this.lastAnimationTime;
            if (dt > 1e3/this.fps)
            {
                this.incrementMovingFrame();
                this.lastAnimationTime = _currentRenderTime;
            }
        }
        else
        {
            this.currentFrameIndex = 0;
        }

        var currentFrame = this.textures[this.currentFrameIndex];
        if (currentFrame == undefined)
            return;

        /*var scaleCoef = 1;
        if ( (_currentRenderTime - scaleTime) / 1e3 > 5 )
        {
            scaleCoef = 1.5;
        }*/
//        var scaleX = this.isMovedLeft ? -scaleCoef : scaleCoef;
        var scaleX = this.isMovedLeft ? -1 : 1;
        this.context.save();
        this.context.translate(this.x, this.y);
        this.context.scale(scaleX, 1);
//        this.context.scale(scaleX, scaleCoef);
        this.context.drawImage(_jakeImg, currentFrame.dx , currentFrame.dy, currentFrame.dw, currentFrame.dh, this.drawX(0), this.drawY(0), this.width, this.height);
        this.context.restore();
    };

    Pes.prototype.updatePosition = function(x, y)
    {
        var     x1  = this.x,
                y1  = this.y,
                x2 = x,
                y2 = y;

        if (!collision(this.width, this.height))
        {
            var totalS = Math.sqrt( (Math.pow( (x2 - x1), 2 )) + (Math.pow( (y2 - y1), 2 )) );
            var currS = SPEED * _deltaRenderTime / 1e3;

            var dx = (currS * (x2 - x1) / totalS);
            var dy = (currS * (y2 - y1) / totalS);

            this.isMovedLeft = !(dx >= 0);

            this.x += dx;
            this.y += dy;

            // корректировка, чтобы не "уехал" влево-вверх:
            if (this.x <= 0)
                this.x = this.width;
            if (this.x >= WIDTH)
                this.x = WIDTH - this.width/2;
            if (this.y <= 0)
                this.y = this.height;
            if (this.y >= HEIGHT)
                this.y = HEIGHT - this.height/2;

            this.isMoved = true;
        }
        else
        {
            this.isMoved = false;
        }

        function collision(w, h)
        {
            return Math.abs(x1 - x2) < w/2 && Math.abs(y1 - y2) < h/2;
        }
    };
    /* class Rocket */
    function Rocket(x, y, w, h, textures, context, fps)
    {
        this.x = x;
        this.y = y;
        this.width = w;
        this.height = h;
        this.textures = textures;
        this.context = context;
        this.fps = fps;

        this.targetX = 0;
        this.targetY = 0;
        this.rotateRadius = 45;
        this.isMoved = false;
        this.currentFrameIndex = 0;
        this.lastAnimationTime = 0;

        this.drawX = function(x)
        {
            return (x - this.width / 2);
        };
        this.drawY = function(y)
        {
            return (y - this.height / 2);
        };
    }

    Rocket.prototype.draw = function()
    {
        this.context.save();
        this.context.translate(this.x, this.y);
        this.context.fillStyle = "red";
//        this.context.drawImage(_rocketImg, currentFrame.dx , currentFrame.dy, currentFrame.dw, currentFrame.dh, this.drawX(0), this.drawY(0), this.width, this.height);
        this.context.fillRect(this.drawX(0), this.drawY(0), this.width, this.height);
        this.context.restore();
    };

    Rocket.prototype.updatePosition = function(x, y)
    {
        this.x = x;
        this.y = y;
    };

    Rocket.prototype.updateTarget = function(x, y)
    {

        this.targetX = x;
        this.targetY = y;

        var     x1  = this.x,
                y1  = this.y,
                x2 = this.targetX,
                y2 = this.targetY;

        calculateAngle();

        if (!collision(this.width, this.height))
        {
            if (!needChangeDirection(this.rotateRadius))
            {
                var totalS = Math.sqrt( (Math.pow( (x2 - x1), 2 )) + (Math.pow( (y2 - y1), 2 )) );
                var currS = SPEED/2 * _deltaRenderTime / 1e3;

                var dx = (currS * (x2 - x1) / totalS);
                var dy = (currS * (y2 - y1) / totalS);

                this.x += dx;
                this.y += dy;
            }
            else
            {
                //TODO
            }
        }


        function collision(w, h)
        {
            return Math.abs(x1 - x2) < w/2 && Math.abs(y1 - y2) < h/2;
        }

        function needChangeDirection(rotateRadius)
        {
//            return Math.abs(x1 - x2) > 2*rotateRadius && Math.abs(y1 - y2) > 2*rotateRadius;
            var ds = Math.sqrt( (Math.pow( (x2 - x1), 2 )) + (Math.pow( (y2 - y1), 2 )) );

            var needChangeDirection = ds < 2*rotateRadius;
            if (needChangeDirection)
            {
                console.log("rotateRadius: " + rotateRadius + ", ds: " + ds);
                console.log();
            }
            return needChangeDirection;
        }

        function calculateAngle()
        {
            var angle = Math.atan((y2 - y1) / (x2 - x1)) * 180 / Math.PI;
            if (x2 - x1 < 0 && y2 - y1 > 0)
                angle = 180 + angle;
            if (x2 - x1 < 0 && y2 - y1 < 0)
                angle = 180 + angle;
            if (x2 - x1 > 0 && y2 - y1 < 0)
                angle = 360 + angle;
            console.log("angle = " + angle);
            return angle;
        }
    };


</script>
</body>
</html>